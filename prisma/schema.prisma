// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ──────────────────────────────────────────────────────
//  USER / SESSION
// ──────────────────────────────────────────────────────
//

model User {
  id                      Int                     @id @default(autoincrement())
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  userName                String?
  userImageURL            String?
  email                   String                  @unique
  about                   String?
  hash                    String
  otpHash                 String?
  isVerificated           Boolean
  currentCompanyId        Int?
  currentCompany          Company?                @relation("CurrentUserCompany", fields: [currentCompanyId], references: [id])
  sessions                Session[]
  invitedCuppings         Cupping[]               @relation("CuppingInvitedUsers")
  sampleTestings          SampleTesting[]
  cuppingSettings         CuppingSettings[]
  createdCuppings         Cupping[]               @relation("CreatedCuppingsByUser")
  relatedToCompanies      UserToCompanyRelation[] @relation("RelatedCompanies")
  sentFriendships         Friendship[]            @relation("FriendshipSender")
  receivedFriendships     Friendship[]            @relation("FriendshipReceiver")
  sentTeamInvitations     TeamInvitation[]        @relation("TeamInvitationSender")
  receivedTeamInvitations TeamInvitation[]        @relation("TeamInvitationReceiver")
}

model Session {
  id        Int         @id @default(autoincrement())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  hashedRt  String?
  userId    Int
  user      User        @relation(fields: [userId], references: [id])
  type      SessionType
}

enum SessionType {
  IOS
  ANDROID
  WEB
}

//
// ──────────────────────────────────────────────────────
//  RELATION / USER REQUESTS
// ──────────────────────────────────────────────────────
//

model UserToCompanyRelation {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    Int
  companyId Int

  user    User    @relation("RelatedCompanies", fields: [userId], references: [id])
  company Company @relation("RelatedUsers", fields: [companyId], references: [id])

  role Role

  @@unique([userId, companyId])
}

enum FriendshipType {
  REQUEST
  FRIEND
  DENIED
  ENDED
}

enum TeamInvitationType {
  REQUEST
  TEAM
  DENIED
  ENDED
}

model Friendship {
  id                  Int            @id @default(autoincrement())
  sender              User           @relation("FriendshipSender", fields: [senderId], references: [id])
  senderId            Int
  receiver            User           @relation("FriendshipReceiver", fields: [receiverId], references: [id])
  receiverId          Int
  type                FriendshipType
  createdAt           DateTime       @default(now())
  wasLoadedByReceiver Boolean        @default(false)
}

model TeamInvitation {
  id                  Int                @id @default(autoincrement())
  companyId           Int
  company             Company            @relation("TeamInvitationCompany", fields: [companyId], references: [id])
  sender              User               @relation("TeamInvitationSender", fields: [senderId], references: [id])
  senderId            Int
  receiver            User               @relation("TeamInvitationReceiver", fields: [receiverId], references: [id])
  receiverId          Int
  type                TeamInvitationType
  createdAt           DateTime           @default(now())
  wasLoadedByReceiver Boolean            @default(false)
}

//
// ──────────────────────────────────────────────────────
//  COMPANY / ROLE
// ──────────────────────────────────────────────────────
//

enum Role {
  OWNER
  CHIEF
  BARISTA
}

model Company {
  id              Int                     @id @default(autoincrement())
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  relatedToUsers  UserToCompanyRelation[] @relation("RelatedUsers")
  sampleTypes     SampleType[]            @relation("SampleTypesOwnedByCompany")
  coffeePacks     CoffeePack[]
  cuppings        Cupping[]
  cuppingSettings CuppingSettings[]
  cuppingResult   CuppingResult[]
  sampleTesting   SampleTesting[]
  currentTeam     User[]                  @relation("CurrentUserCompany")
  isPersonal      Boolean
  companyName     String
  companyImageURL String?
  teamInvitations TeamInvitation[]        @relation("TeamInvitationCompany")
  companyRules    CompanyRule[]           @relation("CompanyRuleRelation")
}

enum CompanyRuleType {
  isOwnerChief
  canChiefMakeChief
  canChiefInviteUser
  canChiefCreateCupping
  isChiefRatesPreferred
  canBaristaInviteUsers
  canBaristaCreateCupping
}

model CompanyRule {
  id              Int             @id @default(autoincrement())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  name            String
  value           Boolean
  company         Company         @relation("CompanyRuleRelation", fields: [companyId], references: [id])
  companyId       Int
  companyRuleType CompanyRuleType
  ruleForRole     Role
}

//
// ──────────────────────────────────────────────────────
//  CUPPING / RESULT / SETTINGS
// ──────────────────────────────────────────────────────
//

model Cupping {
  id               Int             @id @default(autoincrement())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  cuppingCreatorId Int
  cuppingCreator   User            @relation("CreatedCuppingsByUser", fields: [cuppingCreatorId], references: [id])
  cuppingName      String
  companyId        Int
  company          Company         @relation(fields: [companyId], references: [id])
  settingsId       Int
  settings         CuppingSettings @relation(fields: [settingsId], references: [id])
  invitedUsers     User[]          @relation("CuppingInvitedUsers")
  coffeePacks      CoffeePack[]    @relation("CuppingCoffeePacks")
  sampleTestings   SampleTesting[]
  cuppingResult    CuppingResult?
}

model CuppingResult {
  id                   Int                      @id @default(autoincrement())
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  companyId            Int
  company              Company                  @relation(fields: [companyId], references: [id])
  cuppingId            Int                      @unique
  cupping              Cupping                  @relation(fields: [cuppingId], references: [id])
  cuppingTimeInSeconds Int
  results              CuppingResultForSample[]
}

model CuppingResultForSample {
  id                     Int            @id @default(autoincrement())
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  cuppingResultId        Int
  cuppingResult          CuppingResult  @relation(fields: [cuppingResultId], references: [id])
  averageScore           Int
  averageSampleTestingId Int?
  sampleTesting          SampleTesting? @relation(fields: [averageSampleTestingId], references: [id])
}

model CuppingSettings {
  id                    Int       @id @default(autoincrement())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  randomSamplesOrder    Boolean
  openSampleNameCupping Boolean
  singleUserCupping     Boolean
  inviteAllTeammates    Boolean
  cuppings              Cupping[]
  companyId             Int
  company               Company   @relation(fields: [companyId], references: [id])
  userId                Int
  user                  User      @relation(fields: [userId], references: [id])
}

//
// ──────────────────────────────────────────────────────
//  SAMPLE TYPE / ITEM / ROAST TYPE / COFFEE TYPE
// ──────────────────────────────────────────────────────
//

model SampleType {
  id                Int          @id @default(autoincrement())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  originCompanyName String
  sampleName        String
  roastTypeId       Int
  roastType         RoastType    @relation(fields: [roastTypeId], references: [id])
  coffeTypeId       Int
  coffeeType        CoffeeType   @relation(fields: [coffeTypeId], references: [id])
  company           Company[]    @relation("SampleTypesOwnedByCompany")
  sampleItems       CoffeePack[]
}

model CoffeePack {
  id            Int             @id @default(autoincrement())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  companyId     Int
  company       Company         @relation(fields: [companyId], references: [id])
  sampleTypeId  Int
  sampleType    SampleType      @relation(fields: [sampleTypeId], references: [id])
  roastDate     DateTime
  openDate      DateTime
  weight        Int
  barCode       String
  cuppings      Cupping[]       @relation("CuppingCoffeePacks")
  sampleTesting SampleTesting[]
}

model RoastType {
  id         Int          @id @default(autoincrement())
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  value      String
  isCustom   Boolean
  sampleType SampleType[]
}

model CoffeeType {
  id         Int          @id @default(autoincrement())
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  value      String
  isCustom   Boolean
  sampleType SampleType[]
}

//
// ──────────────────────────────────────────────────────
//  SAMPLE TESTING / PROPERTIES
// ──────────────────────────────────────────────────────
//

model SampleTesting {
  id                       Int                      @id @default(autoincrement())
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  userId                   Int
  user                     User                     @relation(fields: [userId], references: [id])
  companyId                Int
  company                  Company                  @relation(fields: [companyId], references: [id])
  cuppingId                Int
  cupping                  Cupping                  @relation(fields: [cuppingId], references: [id])
  coffeePackId             Int
  coffeePack               CoffeePack               @relation(fields: [coffeePackId], references: [id])
  userTestingTimeInSeconds Int
  userSampleProperties     SampleProperty[]
  cuppingResultForSample   CuppingResultForSample[]
}

model SampleProperty {
  id              Int           @id @default(autoincrement())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  propertyTypeId  Int
  propertyType    PropertyType  @relation(fields: [propertyTypeId], references: [id])
  intensity       Int
  quality         Int
  comment         String
  sampleTestingId Int
  sampleTesting   SampleTesting @relation(fields: [sampleTestingId], references: [id])
}

model PropertyType {
  id               Int              @id @default(autoincrement())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  propertyName     String
  sampleProperties SampleProperty[]
}
